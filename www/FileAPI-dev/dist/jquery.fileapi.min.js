/*! fileapi 2.1.0 - BSD | git://github.com/mailru/FileAPI.git */
!function(a,b){"use strict";var c=a.noop,d=!a.fn.prop,e=d?"attr":"prop",f="data-fileapi",g="data-fileapi-id",h=function(d,e){if(this.$el=d=a(d).on("change.fileapi",a.proxy(this,"_onSelect")),this.el=d[0],this._options={},this.options=e=a.extend({url:0,data:{},accept:0,multiple:!1,paramName:0,dataType:"json",duplicate:!1,chunkSize:0,chunkUploadRetry:3,maxSize:0,maxFiles:0,imageSize:0,sortFn:0,filterFn:0,autoUpload:!1,lang:{B:"bytes",KB:"KB",MB:"MB",GB:"GB",TB:"TB"},sizeFormat:"0.00",imageTransform:0,elements:{ctrl:{upload:'[data-fileapi="ctrl.upload"]',reset:'[data-fileapi="ctrl.reset"]',abort:'[data-fileapi="ctrl.abort"]'},empty:{show:'[data-fileapi="empty.show"]',hide:'[data-fileapi="empty.hide"]'},emptyQueue:{show:'[data-fileapi="emptyQueue.show"]',hide:'[data-fileapi="emptyQueue.hide"]'},active:{show:'[data-fileapi="active.show"]',hide:'[data-fileapi="active.hide"]'},size:'[data-fileapi="size"]',name:'[data-fileapi="name"]',progress:'[data-fileapi="progress"]',file:{tpl:'[data-fileapi="file.tpl"]',progress:'[data-fileapi="file.progress"]',active:{show:'[data-fileapi="active.show"]',hide:'[data-fileapi="active.hide"]'},preview:{el:0,get:0,width:0,height:0,processing:0}},dnd:{el:'[data-fileapi="dnd"]',hover:"dnd_hover"}},onDrop:c,onDropHover:c,onSelect:c,onUpload:c,onProgress:c,onComplete:c,onFileUpload:c,onFileProgress:c,onFileComplete:c},e),!e.url){var g=this.$el.attr("action")||this.$el.find("form").attr("action");g?e.url=g:this._throw("url â€” is not defined")}this.$files=this.elem("list"),this.itemTplFn=a.fn.fileapi.tpl(a("<div/>").append(this.elem("file.tpl")).html()),b.each(e,function(a,b){this._setOption(b,a)},this),this.$el.on("reset.fileapi",a.proxy(this,"_onReset")).on("submit.fileapi",a.proxy(this,"_onSubmit")).on("upload.fileapi progress.fileapi complete.fileapi",a.proxy(this,"_onUploadEvent")).on("fileupload.fileapi fileprogress.fileapi filecomplete.fileapi",a.proxy(this,"_onFileUploadEvent")).on("click","["+f+"]",a.proxy(this,"_onActionClick"));var h=e.elements.ctrl;h&&(h.reset&&this.$el.on("click.fileapi",h.reset,a.proxy(this,"_onReset")),h.upload&&this.$el.on("click.fileapi",h.upload,a.proxy(this,"_onSubmit"))),this.elem("dnd.el",!0).dnd(a.proxy(this,"_onDropHover"),a.proxy(this,"_onDrop")),this.$progress=this.elem("progress"),this._crop={},this._rotate={},this.files=[],this.uploaded=[],this.clear()};h.prototype={constructor:h,_throw:function(a){throw"jquery.fileapi: "+a},_getFiles:function(a,c){var d=this.options,e=d.maxSize,f=d.filterFn,g=b.getFiles(a),h={all:g,files:[],other:[],duplicate:d.duplicate?[]:this._extractDuplicateFiles(g)},i=d.imageSize,j=this;i||f?b.filterFiles(g,function(a,b){var c=!0;return b&&i&&(c=(!i.minWidth||b.width>=i.minWidth)&&(!i.minHeight||b.height>=i.minHeight)&&(!i.maxWidth||b.height<=i.maxWidth)&&(!i.maxHeight||b.height<=i.maxHeight)),c&&(!e||a.size<=e)&&(!f||f(a,b))},function(a,b){h.files=a,h.other=b,c.call(j,h)}):(b.each(g,function(a){h[!e||a.size<=e?"files":"other"].push(a)}),c.call(j,h))},_extractDuplicateFiles:function(a){for(var b,c=[],d=a.length,e=this.files;d--;)for(b=e.length;b--;)if(this._fileCompare(a[d],e[b])){c.push(a.splice(d,1));break}return c},_fileCompare:function(a,b){return a.size==b.size&&a.name==b.name},_getFormatedSize:function(a){var c=this.options,d="B";return a>=b.TB?a/=b[d="TB"]:a>=b.GB?a/=b[d="GB"]:a>=b.MB?a/=b[d="MB"]:a>=b.KB&&(a/=b[d="KB"]),c.sizeFormat.replace(/^\d+([^\d]+)(\d*)/,function(b,e,f){return a=a.toFixed(f.length),(a+"").replace(".",e)+" "+c.lang[d]})},_onSelect:function(b){this._getFiles(b,a.proxy(function(a){a.all.length&&this.emit("select",a)!==!1&&this.add(a.files)},this))},_onActionClick:function(c){var d=c.currentTarget,e=a.attr(d,f),h=a(d).closest("["+g+"]",this.$el),i=h.attr(g),j=!0;"remove"==e?(h.remove(),this.queue=b.filter(this.queue,function(a){return b.uid(a)!=i}),this.files=b.filter(this.files,function(a){return b.uid(a)!=i}),this._redraw()):/^rotate/.test(e)?this.rotate(i,/ccw/.test(e)?"-=90":"+=90"):j=!1,j&&c.preventDefault()},_onSubmit:function(a){this.upload(),a.preventDefault()},_onReset:function(a){this.clear(),a.preventDefault()},_onDrop:function(a){this._getFiles(a,function(a){this.emit("drop",a)!==!1&&this.add(a.files)})},_onDropHover:function(b,c){if(this.emit("dropHover",{state:b,event:c})!==!1){var d=this.option("elements.dnd.hover");d&&a(c.currentTarget).toggleClass(d,b)}},_getUploadEvent:function(b){var c=this.xhr,d={xhr:c,file:c.currentFile,files:c.files,widget:this};return a.extend(d,b)},_emitUploadEvent:function(a){var b=this._getUploadEvent();this.emit(a+"upload",b)},_emitProgressEvent:function(a,b){var c=this._getUploadEvent(b);this.emit(a+"progress",c)},_emitCompleteEvent:function(b,c){var d=this.xhr,e=this._getUploadEvent({error:c,status:d.status,statusText:d.statusText,result:d.responseText});"json"==this.options.dataType&&(e.result=a.parseJSON(e.result)),this.emit(b+"complete",e)},_onUploadEvent:function(a,b){var c=this,d=this.$progress,e=a.type;if("progress"==e)d.stop().animate({width:100*(b.loaded/b.total)+"%"},300);else if("upload"==e)d.width(0);else{var f=function(){d.dequeue(),c.clear()};this.xhr=null,this.active=!1,d.length?d.queue(f):f()}},_onFileUploadPrepare:function(c,d){var e=b.uid(c),f=this._rotate[e],g=this._crop[e];if(f||g){var h=d.imageTransform=d.imageTransform||{};a.isEmptyObject(h)||parseInt(h.maxWidth||h.minWidth||h.width,10)>0||h.type||h.quality?(h.crop=g,h.rotate=f):b.each(h,function(a){a.crop=g,a.rotate=f})}},_onFileUploadEvent:function(a,c){var d=this,e=a.type.substr(4),g=b.uid(c.file),h=this.fileElem(g),i=this._$fileprogress;if(this.__fileId!==g&&(this.__fileId=g,this._$fileprogress=i=h.find(this.option("elements.file.progress"))),"progress"==e)i.stop().animate({width:100*(c.loaded/c.total)+"%"},300);else if("upload"==e||"complete"==e){var j=function(){var a="elements.file."+e;"upload"==e&&(h.find("["+f+'="remove"]').hide(),i.width(0)),i.dequeue(),h.find(d.option(a+".show")).show(),h.find(d.option(a+".hide")).hide()};i.length?i.queue(j):j(),"complete"==e&&(this.uploaded.push(c.file),delete this._rotate[g])}},_redraw:function(){var c=!!this.active,d=this.files,f=!d.length&&!c,h=!this.queue.length&&!c,i=[],j=0,k=this.$files,l=k.children().length,m=this.option("elements.file.preview");b.each(d,function(c,d){var e=b.uid(c);if(i.push(c.name),j+=c.size,k.length&&!this.fileElem(e).length){var f=this.itemTplFn({$idx:l+d,uid:c.uid,name:c.name,type:c.type,size:c.size,sizeText:this._getFormatedSize(c.size)});k.append(a(f).attr(g,e)),m.el&&this._makeFilePreview(e,c,m)}},this),this.elem("name").text(i.join(", ")),this.elem("size").text(this._getFormatedSize(j)),this.__empty!==f&&(this.__empty=f,this.elem("empty.show").toggle(f),this.elem("empty.hide").toggle(!f)),this.__emptyQueue!==h&&(this.__emptyQueue=f,this.elem("emptyQueue.show").toggle(h),this.elem("emptyQueue.hide").toggle(!h)),this.__active!==c&&(this.__active=c,this.elem("active.show").toggle(c),this.elem("active.hide").toggle(!c),this.$(".js-fileapi-wrapper,:file")[c?"attr":"removeAttr"]("aria-disabled",c)[e]("disabled",c)),this.elem("ctrl.upload").add(this.elem("ctrl.reset"))[f||c?"attr":"removeAttr"]("aria-disabled",f||c)[e]("disabled",f||c)},_makeFilePreview:function(a,c,d,e){var f=this,g=e?f.$(d.el):f.fileElem(a).find(d.el);if(/^image/.test(c.type)){b.log("_makeFilePreview:",a,c);var h=b.Image(c),i=function(){h.get(function(b,e){f._crop[a]||(b?(d.get&&d.get(g,c),f.emit("filePreviewError",{error:b,file:c})):g.html(e))})};d.width&&h.preview(d.width,d.height),d.rotate&&h.rotate(d.rotate),d.processing?d.processing(c,h,i):i()}else d.get&&d.get(g,c)},emit:function(b,c){var d,e=this.options,f=a.Event(b);return f.widget=this,b=a.camelCase("on-"+b.replace(/(file)(upload)/,"$1-$2")),a.isFunction(e[b])&&(d=e[b].call(this.el,f,c)),d!==!1&&this.$el.triggerHandler(f,c)},add:function(a){if(a.length){var c=this.options,d=c.sortFn,e=c.elements.preview;d&&a.sort(d),e&&e.el&&b.each(a,function(a){this._makeFilePreview(b.uid(a),a,e,!0)},this),this.xhr&&this.xhr.append(a),this.queue=this.queue.concat(a),this.files=this.files.concat(a),this.options.autoUpload?this.upload():this._redraw()}},$:function(b,c){return"string"==typeof b&&(b=/^#/.test(b)?b:(c?a(c):this.$el).find(b)),a(b)},elem:function(b,c){var d=this.option("elements."+b);return void 0===d&&c&&(d=this.option("elements."+b.substr(0,b.lastIndexOf(".")))),this.$("string"!=a.type(d)&&a.isEmptyObject(d)?[]:d)},fileElem:function(a){return this.$("["+g+'="'+a+'"]')},option:function(c,d){if(void 0!==d&&a.isPlainObject(d))return b.each(d,function(a,b){this.option(c+"."+b,a)},this),this;var e,f,g=this.options,h=g[c],i=0;if(-1!=c.indexOf("."))for(h=g,c=c.split("."),e=c.length;e>i;i++){if(f=c[i],void 0!==d&&1===e-i){h[f]=d;break}void 0===h[f]&&(h[f]={}),h=h[f]}else void 0!==d&&(g[c]=d);return void 0!==d&&(this._setOption(c,d,this._options[c]),this._options[c]=d),void 0!==d?d:h},_setOption:function(a,b){switch(a){case"accept":case"multiple":case"paramName":"paramName"==a&&(a="name"),b&&this.$(":file")[e](a,b)}},serialize:function(){var b,c={};return this.$el.find(":input").each(function(d,e){(d=e.name)&&!e.disabled&&(e.checked||/select|textarea|input/i.test(e.nodeName)&&/checkbox|radio/i.test(e.type))&&(b=a(e).val(),void 0!==c[d]?(c[d].push||(c[d]=[c[d]]),c[d].push(b)):c[d]=b)}),c},upload:function(){if(!this.active){this.active=!0;var c=this.$el,d=this.options,e={},f={url:d.url,data:a.extend({},this.serialize(),d.data),files:e,chunkSize:0|d.chunkSize,chunkUploadRetry:0|d.chunkUploadRetry,prepare:a.proxy(this,"_onFileUploadPrepare"),imageTransform:d.imageTransform};e[c.find(":file").attr("name")||"files[]"]=this.queue,b.each(["upload","progress","complete"],function(b){f[b]=a.proxy(this,a.camelCase("_emit-"+b+"Event"),""),f["file"+b]=a.proxy(this,a.camelCase("_emit-"+b+"Event"),"file")},this),this.xhr=b.upload(f),this._redraw()}},crop:function(c,d){var e=b.uid(c),f=this.options,g=f.multiple?this.option("elements.file.preview"):f.elements.preview,h=(f.multiple?this.fileElem(e):this.$el).find(g&&g.el);h.length&&b.getInfo(c,a.proxy(function(e,f){if(!e){h.find("div>div").length||h.html(a("<div><div></div></div>").css(g).css("overflow","hidden")),this.__cropFile!==c&&(this.__cropFile=c,b.Image(c).get(function(b,c){h.find(">div>div").html(a(c).width("100%").height("100%"))},"exactFit"));var i=g.width/d.w,j=g.height/d.h;h.find(">div>div").css({width:Math.round(i*f.width),height:Math.round(j*f.height),marginLeft:-Math.round(i*d.x),marginTop:-Math.round(j*d.y)})}},this)),this._crop[e]=d},rotate:function(a,c){var d="object"==typeof a?b.uid(a):a,e=this.options,f=e.multiple?this.option("elements.file.preview"):e.elements.preview,g=(e.multiple?this.fileElem(d):this.$el).find(f&&f.el),h=this._rotate;/([+-])=/.test(c)?c=h[d]=(h[d]||0)+("+"==RegExp.$1?1:-1)*c.substr(2):h[d]=c,g.css({"-webkit-transform":"rotate("+c+"deg)","-moz-transform":"rotate("+c+"deg)",transform:"rotate("+c+"deg)"})},clear:function(){this.queue=[],this._redraw()},widget:function(){return this},destroy:function(){this.$el.off(".fileapi").removeData("fileapi")}},a.fn.fileapi=function(b,c){var d=this.data("fileapi");if(d){if("widget"===b)return d;if("string"==typeof b){var e,f=d[b];return a.isFunction(f)?e=f.call(d,c,arguments[2]):void 0===f&&(e=this.option(b,c)),void 0===e?this:e}}else this.data("fileapi",new h(this,b));return this},a.fn.fileapi.version="0.1.0",a.fn.fileapi.tpl=function(a){var b=0,c="__b+='";return a.replace(/(?:&lt;|<)%([-=])?([\s\S]+?)%(?:&gt;|>)|$/g,function(d,e,f,g){return c+=a.slice(b,g).replace(/[\r\n"']/g,function(a){return"\\"+a}),f&&(c+=e?"'+\n((__x=("+f+"))==null?'':"+("-"==e?"__esc(__x)":"__x")+")\n+'":"';\n"+f+"\n__b+='"),b=g+d.length,d}),new Function("ctx","var __x,__b='',__esc=function(val){return typeof val=='string'?val.replace(/</g,'&lt;').replace(/\"/g,'&quot;'):val;};with(ctx||{}){\n"+c+"';\n}return __b;")},a.fn.cropper=function(c){var d=this,e=c.file;return"string"==typeof c?d.Jcrop(c):b.getInfo(e,function(f,g){var h=b.Image(e);c.maxSize&&h.resize(c.maxSize[0],c.maxSize[1],"max"),h.get(function(e,f){c.setSelect=c.setSelect||[0,0,f.width,f.height],b.each(["onSelect","onChange"],function(a,b){(b=c[a])&&(c[a]=function(a){var c=g.width/f.width,d=g.height/f.height;b({x:0|a.x*c+.5,y:0|a.y*d+.5,w:0|a.w*c+.5,h:0|a.h*d+.5})})}),d.css("lineHeight",0).html(a(f).css("margin",0)).trigger("resize").Jcrop("destroy").Jcrop(c)})}),d}}(jQuery,FileAPI);